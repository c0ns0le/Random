Netbackup Synthetic Scheduler, written by Jeff White

The Netbackup Synthetic Scheduler controls when a "real" full backup and when a
"synthetic" full backup of a client happens.  Each backup is controlled by a
configuration file (stored in /usr/local/nbu_synth_scheduler/policies/) an
example of which is:

<BEGIN EXAMPLE>
[main]
client = mbtest.cssd.example.edu
enabled = 1
num_synths_before_real_full = 3
frequency = monthly
policy = SYNTH-TEST-JAW171
weekday = wednesday
<END EXAMPLE>

All settings shown are required and the file name must end in ".conf".  The frequency settings only supports "monthly"
(28 days) and "weekly" (7 days).  The policy should already be configured in Netbackup.  
The policy must have 3 schedules defined:
REAL-FULL: A normal full backup with no start window.
SYNTH-FULL: A synthetic full backup with no start window.
CUM/DIFF: A frequency-based cumulative or differential backup with a start window that 
will not run at the time the Netbackup Synthetic Scheduler runs from cron.

This program works as follows:

Every day at 8:00 the program is invoked from cron with no options and every
configuration file as an arguement.  This is the master process who forks a
child for each configuration.  Each child then parses the configuration file,
checks it for missing settings then looks at what options the master process was
called with.  Supported options are:

<BEGIN USAGE DISPLAY>
Usage: nbu_synth_scheduler.py [options] config_file
Run real or synthetic full backups in Netbackup based off a configuration file

Options:
  -h, --help            show this help message and exit
  -r, --report          Report mode, do no backup just show state of the
                        policy (last backup time, synths remaining, etc.)
  -f BACKUP_TYPE, --force=BACKUP_TYPE
                        Force a backup to run ignoring the failure count and
                        schedueld weekday.  Requires an argument of 'real' or
                        'synth'.
  -s REMAINING_SYNTHS, --set=REMAINING_SYNTHS
                        Set the number of remaining synths, argument must be
                        an integer.
<END USAGE DISPLAY>

The --report option displays the current state of the backups and configuration of
a given configuration file, such as:

<BEGIN EXAMPLE REPORT>
NBU Synth Scheduler - Master (32475) - 2014-07-16 11:49:07 - Forked child '32476' for policy file 'test.conf'
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Starting run.
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Non-zero sized pickle file found, opening it.
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Policy: SYNTH-TEST-JAW171
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Client: mbtest.cssd.example.edu
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Enabled: Yes
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Frequency: monthly
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Weekday: wednesday
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Number of synthetics before a real full: 3
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Last real full: 2014-07-16 11:19:06
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Last synth full: 2014-07-16 11:31:29
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Number of synthetic fulls remaining: 2
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Failure count: 1
NBU Synth Scheduler - test.conf - 2014-07-16 11:49:07 - Ending report mode run.
NBU Synth Scheduler - Master (32475) - 2014-07-16 11:49:07 - All child processes exited, exiting.
<END EXAMPLE REPORT>

The --force option is used to force a backup to be attempted even if the current
weekday is not the configured weekday and/or the failure counter is at 3 (the
configured maximum failure limit).  This is used, for example, if the scheduled
backup attempted to run but failed 3 times but now whatever the problem was has
been resolved and an administrator now wants to re-attempt a backup.  This is
REQUIRED whenever the failure counter hits 3.  The program WILL NOT ATTEMPT A
SCHEDULED BACKUP IF THAT COUNTER IS 3 OR HIGHER.  An adminitrator must correct
what caused the failure and run a forced backup using this program, NOT A MANUAL
BACKUP FROM THE NETBACKUP GUI.

The --set option is used to set the number of synthetic fulls still to be done 
before the next real full will be ran.  This is only normally used if an 
administrator decides to change the real-to-full ratio and therefore changes 
the num_synths_before_real_full value in the configuration file.  Changing that 
value does not change how many synthetic fulls remain before the next real full 
(unless the next full was already going to be a real full) so this option allows 
an administrator to explicitly set/reset it.  For example, if 
num_synths_before_real_full was set to 3 then after a 3 backups later (1 real, 
2 synthetic)  changed it to 6 the program would still think there was only 1 
more synthetic before the next real so the adminsitrator can use --set to change 
that to a value that matches the change, in this case 4.

